<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ø±Ø­Ù„ØªÙŠ ÙÙŠ Ø§Ù„ØªØ¹Ù„Ù… - Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</title>
<style>
  :root{
    --primary:#2e7d32; --primary-2:#66bb6a; --bg:#f9fbe7; --card:#ffffff;
    --danger:#d32f2f; --warn:#f9a825; --ok:#2e7d32; --muted:#6b7280;
    --shadow:0 8px 18px rgba(0,0,0,.08);
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{
    font-family: 'Tajawal', Arial, sans-serif;
    background: var(--bg);
    margin:0; color:#0f172a;
  }
  header{
    background: linear-gradient(180deg,var(--primary),var(--primary-2));
    color:#fff; padding:18px 16px; position:sticky; top:0; z-index:5;
    box-shadow:var(--shadow);
  }
  header .row{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
  .brand{display:flex; align-items:center; gap:10px}
  .brand .logo{
    width:44px; height:44px; background:#fff; color:var(--primary);
    border-radius:50%; display:grid; place-items:center; font-weight:700;
  }
  nav a{
    color:#fff; text-decoration:none; padding:8px 12px; border-radius:10px;
    font-weight:600; opacity:.95; transition:.2s;
  }
  nav a:hover{background:rgba(255,255,255,.15)}
  main{max-width:1100px; margin:22px auto; padding:0 14px; display:grid; gap:18px}
  .grid{display:grid; gap:18px}
  @media(min-width:900px){ .grid{grid-template-columns: 1.1fr 1fr} }

  .card{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:16px 16px 18px;
  }
  .card h3{margin:0 0 12px 0; font-size:1.15rem}
  .muted{color:var(--muted); font-size:.92rem}

  /* Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ */
  .student{
    display:grid; grid-template-columns: 96px 1fr; gap:14px; align-items:center;
  }
  .avatar{
    width:96px; height:96px; border-radius:18px; overflow:hidden; border:3px solid #e6ffe6;
  }
  .avatar img{width:100%; height:100%; object-fit:cover}
  .student .info{display:grid; gap:6px}
  .progress{height:10px; background:#eef2ff; border-radius:999px; overflow:hidden}
  .progress > span{display:block; height:100%; background:linear-gradient(90deg,#43a047,#a5d6a7)}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .row.wrap{flex-wrap:wrap}
  .pill{
    background:#eef7ee; color:#14532d; padding:6px 10px; border-radius:999px; font-size:.85rem;
  }

  /* Ø§Ù„Ù†ÙÙ‚Ø§Ø· ÙˆØ§Ù„Ù…ÙƒØ§ÙØ¢Øª */
  .points{display:grid; gap:10px}
  .points .big{
    font-size:2rem; font-weight:800; color:var(--primary);
  }
  .btn{
    border:none; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:700;
    box-shadow:var(--shadow); background:#f1f5f9;
  }
  .btn.primary{background:linear-gradient(180deg,#43a047,#81c784); color:white}
  .btn.ghost{background:#fff}
  .btn.danger{background:linear-gradient(180deg,#d32f2f,#ef5350); color:#fff}
  .btn.warn{background:linear-gradient(180deg,#f9a825,#ffd54f)}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .badge{background:#e8f5e9; color:#1b5e20; border-radius:10px; padding:4px 10px; font-size:.85rem}

  /* Ø§Ù„Ø£Ù†Ø´Ø·Ø© */
  .activity-form label{display:block; margin:.4rem 0 .2rem}
  .activity-form input, .activity-form textarea, .activity-form select{
    width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:12px; background:#fff;
    outline:none; transition:.2s;
  }
  .activity-form input:focus, .activity-form textarea:focus{border-color:#93c5fd; box-shadow:0 0 0 3px #e0f2fe}
  .activities{display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:12px}
  .tile{
    border:1px solid #eef2ff; background:#fff; border-radius:14px; overflow:hidden; box-shadow:var(--shadow);
    display:grid; grid-template-rows:140px 1fr; min-height:220px;
  }
  .tile .ph{display:grid; place-items:center; color:#94a3b8; font-size:.9rem; background:#f8fafc}
  .tile img{width:100%; height:140px; object-fit:cover}
  .tile .body{padding:10px; display:grid; align-content:start; gap:6px}
  .tile .meta{font-size:.8rem; color:#64748b; display:flex; justify-content:space-between}

  /* Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª */
  .skills{display:grid; gap:6px}
  .skill{
    display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; padding:10px; border:1px dashed #e2e8f0; border-radius:12px; background:#fcfffc;
  }
  .skill strong{font-size:.98rem}
  .skill input[type="checkbox"]{transform:scale(1.2)}

  /* Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
  .report{display:grid; gap:10px}
  .report pre{
    white-space:pre-wrap; background:#0f172a; color:#e2e8f0; padding:12px; border-radius:12px; overflow:auto;
  }
  .footer{
    text-align:center; padding:18px; color:#94a3b8; font-size:.9rem;
  }
  /* Ø±Ø³Ø§Ø¦Ù„ */
  .alert{
    border-radius:12px; padding:10px; font-size:.92rem; display:none;
  }
  .alert.show{display:block}
  .alert.error{background:#fdecea; color:#b71c1c; border:1px solid #ffcdd2}
  .alert.ok{background:#e8f5e9; color:#1b5e20; border:1px solid #c8e6c9}
</style>
</head>
<body>
<header>
  <div class="row">
    <div class="brand">
      <div class="logo">Ø£</div>
      <div>
        <div style="font-size:1.15rem;font-weight:800">Ø±Ø­Ù„ØªÙŠ ÙÙŠ Ø§Ù„ØªØ¹Ù„Ù…</div>
        <div class="muted" style="font-size:.85rem">Ù…Ù†ØµØ© Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ‚Ø¯Ù… Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</div>
      </div>
    </div>
    <nav class="row">
      <a href="#student">Ø§Ù„Ø·Ø§Ù„Ø¨</a>
      <a href="#points">Ø§Ù„Ù†Ù‚Ø§Ø·</a>
      <a href="#activities">Ø§Ù„Ø£Ù†Ø´Ø·Ø©</a>
      <a href="#skills">Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</a>
      <a href="#report">Ø§Ù„ØªÙ‚Ø±ÙŠØ±</a>
    </nav>
  </div>
</header>

<main>
  <section id="student" class="card">
    <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
    <div class="alert error" id="errBox"></div>
    <div class="student">
      <div class="avatar"><img id="avatar" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨" src="https://i.imgur.com/2yaf2wb.png"></div>
      <div class="info">
        <div class="row wrap">
          <input id="studentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" aria-label="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" style="padding:10px;border:1px solid #e5e7eb;border-radius:12px;min-width:200px"/>
          <input id="studentImg" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" aria-label="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø©" style="padding:10px;border:1px solid #e5e7eb;border-radius:12px;min-width:260px"/>
          <button class="btn primary" id="saveStudent">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <span class="pill" id="saveOk" style="display:none;">âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸</span>
        </div>
        <div class="row" style="justify-content:space-between">
          <div class="muted">Ù†Ø³Ø¨Ø© Ø¥ØªÙ‚Ø§Ù† Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</div>
          <div class="badge"><span id="skillPct">0</span>%</div>
        </div>
        <div class="progress" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…">
          <span id="progressBar" style="width:0%"></span>
        </div>
      </div>
    </div>
  </section>

  <section id="points" class="card">
    <h3>Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ù…ÙƒØ§ÙØ¢Øª</h3>
    <div class="points">
      <div class="row" style="justify-content:space-between; align-items:end">
        <div>
          <div class="muted">Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
          <div class="big" id="pointsTotal">0</div>
        </div>
        <div class="row">
          <button class="btn primary" id="add5">+5 Ù†Ù‚Ø§Ø·</button>
          <button class="btn warn" id="add1">+1</button>
          <button class="btn ghost" id="minus1">-1</button>
          <button class="btn danger" id="resetPoints">ØªØµÙÙŠØ±</button>
        </div>
      </div>
      <div class="row wrap">
        <select id="rewardSelect" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ù…ÙƒØ§ÙØ£Ø©">
          <option value="">Ø§Ø®ØªØ± Ù…ÙƒØ§ÙØ£Ø© Ù„Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„</option>
          <option value="Ù…Ù„ØµÙ‚ Ø°Ù‡Ø¨ÙŠ - 5">Ù…Ù„ØµÙ‚ Ø°Ù‡Ø¨ÙŠ (5 Ù†Ù‚Ø§Ø·)</option>
          <option value="ÙˆØ³Ø§Ù… Ø§Ù„Ù…Ø«Ø§Ø¨Ø±Ø© - 10">ÙˆØ³Ø§Ù… Ø§Ù„Ù…Ø«Ø§Ø¨Ø±Ø© (10 Ù†Ù‚Ø§Ø·)</option>
          <option value="Ø´Ù‡Ø§Ø¯Ø© ØªÙ‚Ø¯ÙŠØ± - 15">Ø´Ù‡Ø§Ø¯Ø© ØªÙ‚Ø¯ÙŠØ± (15 Ù†Ù‚Ø·Ø©)</option>
        </select>
        <button class="btn primary" id="redeemBtn">Ø§Ø³ØªØ¨Ø¯Ø§Ù„</button>
        <span class="muted">Ø§Ù„Ø³Ø¬Ù„:</span>
        <div class="pill" id="lastRedeem">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>
      </div>
    </div>
  </section>

  <section id="activities" class="card">
    <h3>Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
    <form class="activity-form" id="activityForm" novalidate>
      <div class="row wrap">
        <div style="flex:1; min-width:200px">
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ø´Ø§Ø·</label>
          <input id="actTitle" required maxlength="60" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ø±Ø§Ø¡Ø© Ù‚ØµØ© Ù‚ØµÙŠØ±Ø©"/>
        </div>
        <div style="flex:2; min-width:260px">
          <label>ÙˆØµÙ Ù…Ø®ØªØµØ±</label>
          <input id="actDesc" required maxlength="120" placeholder="Ù…Ø§Ø°Ø§ ÙØ¹Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ"/>
        </div>
        <div style="flex:1; min-width:220px">
          <label>Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="actImg" placeholder="https://example.com/photo.jpg" inputmode="url"/>
        </div>
        <div style="flex:1; min-width:160px">
          <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
          <select id="actCat">
            <option>Ù‚Ø±Ø§Ø¡Ø©</option>
            <option>ÙƒØªØ§Ø¨Ø©</option>
            <option>Ø­Ø³Ø§Ø¨</option>
            <option>Ø³Ù„ÙˆÙƒ</option>
            <option>Ù†Ø´Ø§Ø· Ø¬Ù…Ø§Ø¹ÙŠ</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" type="submit">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø´Ø§Ø·</button>
        <button class="btn ghost" id="clearActivities" type="button">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø´Ø·Ø©</button>
      </div>
      <div class="alert error" id="actErr"></div>
    </form>

    <div class="activities" id="activitiesList" aria-live="polite"></div>
  </section>

  <section id="skills" class="card">
    <h3>Ø¬Ø¯ÙˆÙ„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</h3>
    <div class="skills" id="skillsList"></div>
  </section>

  <section id="report" class="card">
    <h3>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
    <div class="report">
      <div class="row wrap">
        <input id="reportMonth" placeholder="Ø§Ù„Ø´Ù‡Ø± (Ù…Ø«Ø§Ù„: Ø£ØºØ³Ø·Ø³ 2025)" style="padding:10px;border:1px solid #e5e7eb;border-radius:12px;min-width:220px"/>
        <button class="btn primary" id="genReport">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        <button class="btn ghost" id="printReport">Ø·Ø¨Ø§Ø¹Ø©</button>
        <button class="btn" id="exportBtn" title="Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ">ØªØµØ¯ÙŠØ± JSON</button>
        <label class="btn" for="importFile" style="cursor:pointer">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</label>
        <input id="importFile" type="file" accept="application/json" style="display:none"/>
      </div>
      <pre id="reportOut" aria-label="Ù†Øµ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"></pre>
      <div class="alert ok" id="importOk">ğŸ‘ ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­</div>
      <div class="alert error" id="importErr">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</div>
    </div>
  </section>

  <div class="footer">Â© Ù…Ù†ØµØ© Ø±Ø­Ù„ØªÙŠ ÙÙŠ Ø§Ù„ØªØ¹Ù„Ù… â€“ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</div>
</main>

<script>
/* ===================== Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© + Ø«ÙˆØ§Ø¨Øª ===================== */
const DEFAULT_SKILLS = [
  { id:'read-letters',   title:'ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø±ÙˆÙ', area:'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©' },
  { id:'read-words',     title:'Ù‚Ø±Ø§Ø¡Ø© ÙƒÙ„Ù…Ø§Øª Ø«Ù„Ø§Ø«ÙŠØ©', area:'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©' },
  { id:'write-letters',  title:'ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø­Ø±ÙˆÙ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', area:'Ø§Ù„ÙƒØªØ§Ø¨Ø©' },
  { id:'write-name',     title:'ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„Ù‹Ø§', area:'Ø§Ù„ÙƒØªØ§Ø¨Ø©' },
  { id:'count-20',       title:'Ø¹Ø¯Ù‘ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø­ØªÙ‰ 20', area:'Ø§Ù„Ø­Ø³Ø§Ø¨' },
  { id:'add-basic',      title:'Ø¬Ù…Ø¹ Ø¨Ø³ÙŠØ· Ø­ØªÙ‰ 10', area:'Ø§Ù„Ø­Ø³Ø§Ø¨' },
  { id:'behavior',       title:'Ø³Ù„ÙˆÙƒ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ', area:'Ø§Ù„Ø³Ù„ÙˆÙƒ' },
  { id:'teamwork',       title:'Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ù†Ø´Ø§Ø· Ø¬Ù…Ø§Ø¹ÙŠ', area:'Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©' },
];

const LS_KEYS = {
  student:'rt_student',
  points:'rt_points',
  activities:'rt_activities',
  skills:'rt_skills'
};

/* ===================== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¢Ù…Ù†Ø© ===================== */
const safeURL = (u)=>{
  try{
    if(!u) return '';
    const url = new URL(u);
    // Ù‚Ø¨ÙˆÙ„ http/https ÙÙ‚Ø·
    if(['http:','https:'].includes(url.protocol)){
      return url.href;
    }
  }catch(_){}
  return '';
};
const el = (q)=>document.querySelector(q);
const fmtDate = (d)=> new Intl.DateTimeFormat('ar-SA', {
  dateStyle:'medium', timeStyle:'short'
}).format(d);

/* ===================== Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (State) ===================== */
let state = {
  student:{ name:'', img:'' },
  points:0,
  activities:[], // {id,title,desc,img,cat,at}
  skills:{}      // {skillId: boolean}
};

/* ===================== ØªØ­Ù…ÙŠÙ„/Ø­ÙØ¸ ===================== */
function loadAll(){
  try{
    const s = JSON.parse(localStorage.getItem(LS_KEYS.student)||'{}');
    const p = JSON.parse(localStorage.getItem(LS_KEYS.points)||'0');
    const a = JSON.parse(localStorage.getItem(LS_KEYS.activities)||'[]');
    const k = JSON.parse(localStorage.getItem(LS_KEYS.skills)||'{}');
    state.student = {name:s.name||'', img:s.img||''};
    state.points = Number.isFinite(p)? p : 0;
    state.activities = Array.isArray(a)? a : [];
    state.skills = typeof k==='object' && k? k : {};
  }catch(e){
    console.error('load err', e);
  }
}
function persist(){
  localStorage.setItem(LS_KEYS.student, JSON.stringify(state.student));
  localStorage.setItem(LS_KEYS.points, JSON.stringify(state.points));
  localStorage.setItem(LS_KEYS.activities, JSON.stringify(state.activities));
  localStorage.setItem(LS_KEYS.skills, JSON.stringify(state.skills));
}

/* ===================== ÙˆØ§Ø¬Ù‡Ø©: Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ===================== */
function renderStudent(){
  el('#studentName').value = state.student.name || '';
  el('#studentImg').value = state.student.img || '';
  const img = state.student.img ? safeURL(state.student.img) : '';
  el('#avatar').src = img || 'https://i.imgur.com/2yaf2wb.png';
  updateSkillProgress();
}
el('#saveStudent').addEventListener('click', ()=>{
  const name = el('#studentName').value.trim();
  const img = el('#studentImg').value.trim();
  const err = el('#errBox');
  err.classList.remove('show'); err.textContent='';
  if(name.length < 2){
    err.textContent = 'âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­ (Ø­Ø±ÙØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).';
    err.classList.add('show'); err.classList.add('error');
    return;
  }
  if(img && !safeURL(img)){
    err.textContent = 'âš ï¸ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ØºÙŠØ± ØµØ§Ù„Ø­. Ø§Ø³ØªØ®Ø¯Ù… http Ø£Ùˆ https.';
    err.classList.add('show'); err.classList.add('error');
    return;
  }
  state.student = {name, img:safeURL(img)};
  persist();
  const ok = el('#saveOk'); ok.style.display='inline-block';
  setTimeout(()=> ok.style.display='none', 1400);
});

/* ===================== ÙˆØ§Ø¬Ù‡Ø©: Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ù…ÙƒØ§ÙØ¢Øª ===================== */
function renderPoints(){
  el('#pointsTotal').textContent = state.points;
}
function addPoints(n){
  state.points = Math.max(0, state.points + n);
  persist(); renderPoints();
}
el('#add5').addEventListener('click', ()=> addPoints(5));
el('#add1').addEventListener('click', ()=> addPoints(1));
el('#minus1').addEventListener('click', ()=> addPoints(-1));
el('#resetPoints').addEventListener('click', ()=>{
  if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø·ØŸ')){ state.points=0; persist(); renderPoints(); }
});
el('#redeemBtn').addEventListener('click', ()=>{
  const sel = el('#rewardSelect').value;
  if(!sel) return;
  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ù…Ù† Ø§Ù„Ù†Øµ
  const cost = Number((sel.match(/(\d+)/)||[])[1]||0);
  if(state.points < cost){
    alert('Ø§Ù„Ù†Ù‚Ø§Ø· ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©.');
    return;
  }
  state.points -= cost; persist(); renderPoints();
  el('#lastRedeem').textContent = `${sel} â€“ ${fmtDate(new Date())}`;
});

/* ===================== ÙˆØ§Ø¬Ù‡Ø©: Ø§Ù„Ø£Ù†Ø´Ø·Ø© ===================== */
function renderActivities(){
  const box = el('#activitiesList');
  box.innerHTML = '';
  if(!state.activities.length){
    const div = document.createElement('div');
    div.className='tile';
    div.innerHTML = `<div class="ph">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© Ø¨Ø¹Ø¯</div><div class="body muted">Ø£Ø¶Ù Ù†Ø´Ø§Ø·Ù‹Ø§ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¹Ù„Ø§Ù‡.</div>`;
    box.appendChild(div);
    return;
  }
  state.activities
    .slice()
    .sort((a,b)=> b.at - a.at)
    .forEach(a=>{
      const d = document.createElement('div');
      d.className='tile';
      const top = a.img? `<img src="${safeURL(a.img)}" alt="ØµÙˆØ±Ø© Ù†Ø´Ø§Ø·">` : `<div class="ph">Ø¨Ø¯ÙˆÙ† ØµÙˆØ±Ø©</div>`;
      d.innerHTML = `
        ${top}
        <div class="body">
          <strong>${escapeHTML(a.title)}</strong>
          <div class="muted">${escapeHTML(a.desc)}</div>
          <div class="meta">
            <span>ğŸ“‚ ${escapeHTML(a.cat)}</span>
            <span>${fmtDate(new Date(a.at))}</span>
          </div>
          <div class="row" style="justify-content:space-between;margin-top:6px">
            <button class="btn ghost" data-id="${a.id}" data-action="del">Ø­Ø°Ù</button>
            <button class="btn" data-id="${a.id}" data-action="give">+1 Ù†Ù‚Ø·Ø©</button>
          </div>
        </div>`;
      box.appendChild(d);
    });
}
function escapeHTML(s=''){
  return s.replace(/[&<>"']/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}
el('#activityForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const err = el('#actErr'); err.classList.remove('show'); err.textContent='';
  const title = el('#actTitle').value.trim();
  const desc  = el('#actDesc').value.trim();
  const img   = el('#actImg').value.trim();
  const cat   = el('#actCat').value;
  // ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ·
  if(title.length<2 || desc.length<4){
    err.textContent = 'âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø¹Ù†ÙˆØ§Ù† ÙˆÙˆØµÙ Ù…Ù†Ø§Ø³Ø¨ÙŠÙ†.';
    err.classList.add('show'); err.classList.add('error'); return;
  }
  if(img && !safeURL(img)){
    err.textContent = 'âš ï¸ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ØºÙŠØ± ØµØ§Ù„Ø­.';
    err.classList.add('show'); err.classList.add('error'); return;
  }
  const item = { id: crypto.randomUUID(), title, desc, img:safeURL(img), cat, at: Date.now() };
  state.activities.push(item); persist();
  (['#actTitle','#actDesc','#actImg']).forEach(q=> el(q).value='');
  renderActivities();
});
el('#activitiesList').addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-action]');
  if(!btn) return;
  const id = btn.getAttribute('data-id');
  const action = btn.getAttribute('data-action');
  if(action==='del'){
    state.activities = state.activities.filter(x=> x.id!==id);
    persist(); renderActivities();
  }else if(action==='give'){
    addPoints(1);
  }
});
el('#clearActivities').addEventListener('click', ()=>{
  if(confirm('Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ')){
    state.activities = []; persist(); renderActivities();
  }
});

/* ===================== ÙˆØ§Ø¬Ù‡Ø©: Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª ===================== */
function renderSkills(){
  const box = el('#skillsList'); box.innerHTML='';
  DEFAULT_SKILLS.forEach(s=>{
    const checked = !!state.skills[s.id];
    const row = document.createElement('div');
    row.className='skill';
    row.innerHTML = `
      <div>
        <strong>${escapeHTML(s.title)}</strong>
        <div class="muted">${escapeHTML(s.area)}</div>
      </div>
      <label class="row" style="gap:8px">
        <span class="muted">ØªÙ… Ø§Ù„Ø¥ØªÙ‚Ø§Ù†</span>
        <input type="checkbox" ${checked?'checked':''} data-skill="${s.id}"/>
      </label>`;
    box.appendChild(row);
  });
  updateSkillProgress();
}
function updateSkillProgress(){
  const total = DEFAULT_SKILLS.length;
  const done = DEFAULT_SKILLS.filter(s=> state.skills[s.id]).length;
  const pct = total? Math.round((done/total)*100) : 0;
  el('#skillPct').textContent = pct;
  el('#progressBar').style.width = pct + '%';
}
el('#skillsList').addEventListener('change', (e)=>{
  const c = e.target.closest('input[type="checkbox"][data-skill]');
  if(!c) return;
  state.skills[c.dataset.skill] = c.checked;
  persist(); updateSkillProgress();
});

/* ===================== Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ===================== */
el('#genReport').addEventListener('click', ()=>{
  const month = el('#reportMonth').value.trim() || 'Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±';
  const skillsDone = DEFAULT_SKILLS.filter(s=> state.skills[s.id]).map(s=> 'â€¢ ' + s.title).join('\n');
  const latestActs = state.activities
                      .slice().sort((a,b)=> b.at-a.at).slice(0,5)
                      .map(a=> `â€¢ [${a.cat}] ${a.title} â€“ ${new Date(a.at).toLocaleDateString('ar-SA')}`)
                      .join('\n');
  const txt =
`ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨: ${state.student.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}
Ø§Ù„Ø´Ù‡Ø±: ${month}

Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${state.points}

Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ù†Ø© (${DEFAULT_SKILLS.filter(s=> state.skills[s.id]).length}/${DEFAULT_SKILLS.length}):
${skillsDone || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ø±Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© Ø¨Ø¹Ø¯'}

Ø£Ø¨Ø±Ø² Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©:
${latestActs || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© Ù…Ø³Ø¬Ù„Ø©'}

Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…:
- Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ ØªØ¹Ø²ÙŠØ² Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.
- ØªØ´Ø¬ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©.
- Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø¨Ù†Ù‚Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ©.`;
  el('#reportOut').textContent = txt;
});
el('#printReport').addEventListener('click', ()=> window.print());

el('#exportBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'backup-rahleti.json';
  a.click();
  URL.revokeObjectURL(a.href);
});
el('#importFile').addEventListener('change', async (e)=>{
  const ok = el('#importOk'), err = el('#importErr');
  ok.classList.remove('show'); err.classList.remove('show');
  try{
    const file = e.target.files?.[0];
    if(!file) return;
    const text = await file.text();
    const data = JSON.parse(text);
    // ØªØ­Ù‚Ù‚ Ø³Ø±ÙŠØ¹ Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if(!('student' in data) || !('points' in data)){ throw new Error('Ù…Ù„Ù ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚'); }
    state = data;
    persist();
    renderStudent(); renderPoints(); renderActivities(); renderSkills();
    ok.classList.add('show');
  }catch(e){
    console.error(e);
    err.textContent = 'ØªØ¹Ø°Ø± Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© JSON.';
    err.classList.add('show');
  }finally{
    e.target.value = '';
  }
});

/* ===================== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ===================== */
loadAll();
renderStudent();
renderPoints();
renderActivities();
renderSkills();
</script>
</body>
</html>
